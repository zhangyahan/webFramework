{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>students</title>
    <link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'plugins/font-awesome/css/font-awesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/home.css' %}">

</head>

<body>

    <div class="container">
        <div style="text-align: center">
            <a type="button" class="btn btn-primary" id="addStudent">添加</a>
            <a type="button" class="btn btn-danger">删除</a>
        </div>
        <table class="table table-bordered table-striped" id="tb">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>姓名</th>
                    <th>年龄</th>
                    <th>性别</th>
                    <th>班级</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for row in students %}
                <tr nid="{{ row.id }}">
                    <td na='nid'>{{ row.id }}</td>
                    <td na='username'>{{ row.username }}</td>
                    <td na='userage'>{{ row.age }}</td>
                    {% if row.gender %}
                    <td na="gender">男</td>
                    {% else %}
                    <td na="gender">女</td>
                    {% endif %}
                    <td na="cls_id" cid="{{ row.cs_id }}">{{ row.cs.title }}</td>
                    <td>
                        <a id="remove" class="remove"><span class="glyphicon glyphicon-remove"></span></a>
                        <a id="change" class="editRow"><span class="fa fa-pencil-square-o"></span></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 添加 -->
    <div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">添加学生</h4>
                </div>
                <div class="modal-body clearfix">

                    <form class="form-horizontal">
                        <div class="form-group">
                            <label for="username" class="col-sm-2 control-label">姓名</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" name="username" placeholder="姓名">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="userage" class="col-sm-2 control-label">年龄</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control" name="userage" placeholder="年龄">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="userage" class="col-sm-2 control-label">性别</label>
                            <div class="col-sm-10">
                                <label class="radio-inline">
                                    <input type="radio" name="gender" value="1"> 男
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="gender" value="0"> 女
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="userage" class="col-sm-2 control-label">班级</label>
                            <div class="col-sm-10">

                                <select class="form-control" name="classes">
                                    {% for class in classes %}
                                    <option value="{{ class.id }}">{{ class.title }}</option>
                                    {% endfor %}
                                </select>

                            </div>
                        </div>

                    </form>


                </div>
                <div class="modal-footer">
                    <span id="errorMsg" style="color:red;"></span>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btnSave">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除框 -->
    <div class="modal fade" id="rmModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="alert alert-danger clearfix" role="alert">
                <h3>删除学生信息?</h3>
                <div><input type="hidden" id="delUid"></div>
                <div class="pull-right">
                    <button type="button" class="btn btn-default" id="cancelDel">取消</button>
                    <button type="button" class="btn btn-danger" id="delConfirm">确定</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除失败 -->
    <div class="modal fade" id="demoModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="alert alert-danger clearfix" role="alert">
                <h1>删除失败</h1>
            </div>
        </div>
    </div>

    <!-- 编辑学生 -->
    <div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">编辑学生</h4>
                </div>
                <div class="modal-body clearfix">

                    <form class="form-horizontal">
                        <input type="hidden" name="nid" value="">
                        <div class="form-group">
                            <label for="username" class="col-sm-2 control-label">姓名</label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control" name="username" placeholder="姓名">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="userage" class="col-sm-2 control-label">年龄</label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control" name="userage" placeholder="年龄">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="userage" class="col-sm-2 control-label">性别</label>
                            <div class="col-sm-10">
                                <label class="radio-inline">
                                    <input type="radio" name="gender" value="1"> 男
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="gender" value="0"> 女
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="userage" class="col-sm-2 control-label">班级</label>
                            <div class="col-sm-10">

                                <select class="form-control" name="classes">
                                    {% for class in classes %}
                                    <option value="{{ class.id }}">{{ class.title }}</option>
                                    {% endfor %}
                                </select>

                            </div>
                        </div>

                    </form>


                </div>
                <div class="modal-footer">
                    <span id="errorMsg" style="color:red;"></span>
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="btnChange">修改</button>
                </div>
            </div>
        </div>
    </div>


    <script src="{% static 'js/jquery.js' %}"></script>
    <script src="{% static 'plugins/bootstrap/js/bootstrap.min.js' %}"></script>
    <script>
        $(function () {
            bindEvent();
            bindSave();
            bindDel();
            binddelConfirm();
            bindcancelDel();
            bindEdit();
            bindChange();
        });
        
        // 绑定修改按钮
        function bindChange () {
            $("#btnChange").click(function () {
                var postList = {};
                // 点击修改按钮, 寻找内容
                $("#editModal").find("input, select").each(function () {
                    var v = $(this).val();
                    console.log(v)
                    var n = $(this).attr("name");
                    console.log(n)
                    if (n == "gender") {
                        if ($(this).prop("checked")) {
                            postList[n] = v;
                        }
                    } else {
                        postList[n] = v;
                    } 
                })
                console.log(postList)
                // 发送AJAX请求
                $.ajax({
                    url: '/students/change/',
                    data: postList,
                    type: 'post',
                    success: function (args) {
                        var args = JSON.parse(args)
                        if (args.status==200) {
                            window.location.reload()
                        } else {
                            alert('修改错误')
                        }
                    }
                })

            })
        }

        /*
        绑定编辑按钮的点击时间
        */
        function bindEdit () {
            $('#tb').on('click', '.editRow', function () {
                // 执行点击事件
                $('#editModal').modal('show')
                // 获取当前行的所有数据,将数据赋值到对应的对话框中
                // 获取父标签的上面的所有标签
                $(this).parent().prevAll().each(function () {
                    var v = $(this).text();
                    // 获取na的值
                    var n = $(this).attr("na");
                    if (n == "cls_id") {
                        var cid = $(this).attr("cid");
                        // 设置seclect的值为cid的值
                        $('#editModal select[name="classes"]').val(cid);
                    } else if (n == "gender") {
                        if (v == '男') {
                            // :radio类型选择器type
                            $('#editModal :radio[value="1"]').prop("checked", true);
                        } else {
                            $('#editModal :radio[value="0"]').prop("checked", true);
                        }
                    } else {
                        $('#editModal input[name="' + n + '"]').val(v)
                    }

                })
            })
        }

        function bindcancelDel() {
            $('#cancelDel').click(function () {
                $('#rmModal').modal('hide')
            })
        }

        function binddelConfirm() {
            $('#delConfirm').click(function () {
                var rowId = $('#delUid').val();
                console.log(rowId)

                $.ajax({
                    url: '/students/del/',
                    type: 'GET',
                    data: { 'delUid': rowId },
                    success: function (args) {
                        // 回调函数
                        // args是字符串,要JSON转成JS字典
                        var dic = JSON.parse(args);
                        if (dic.status) {
                            $('tr[nid="' + rowId + '"]').remove();
                            console.log(rowId)
                        } else {
                            $('#demoModal').modal('show')
                        }
                        $('#rmModal').modal('hide')
                    }
                })

            })
        }

        function bindDel() {
            $('#tb').on('click', '.remove', function () {
                $('#rmModal').modal('show');
                // 获取当前行的ID设置给delUid
                var rowId = $(this).parent().parent().attr('nid');
                $('#delUid').val(rowId);
            })
        }

        function bindEvent() {
            $('#addStudent').click(function () {
                $('#addModal').modal('show')
            })
        }

        function bindSave() {
            $("#btnSave").click(function () {
                var postData = {}
                $("#addModal").find('select,input').each(function () {
                    var value = $(this).val();
                    var name = $(this).attr('name');
                    if (name == "gender") {
                        // 判断有没有此属性
                        if ($(this).prop('checked')) {
                            postData[name] = value;
                        }
                    } else {
                        postData[name] = value;
                    }
                })

                $.ajax({
                    url: '/students/add/',
                    type: 'post',
                    data: postData,
                    success: function (args) {
                        // args是字符串
                        // JSON.parse转换为字段
                        var dic = JSON.parse(args)
                        if (dic.status) {
                            createRow(postData, dic.stu_id);
                            $('#addModal').modal('hide')
                        } else {
                            $('#errorMsg').text(dic.message);
                        }
                    }
                })
            })
        }

        function createRow(postData, stu_id) {
            var tr = document.createElement('tr');
            $(tr).attr('nid', stu_id)
            var tdId = document.createElement('td');
            tdId.innerHTML = stu_id
            $(tr).append(tdId);

            var tdUsername = document.createElement('td');
            tdUsername.innerHTML = postData.username
            $(tr).append(tdUsername);

            var tdUserage = document.createElement('td');
            tdUserage.innerHTML = postData.userage
            $(tr).append(tdUserage);

            var tdGender = document.createElement('td');
            if (postData.gender == '0') {
                tdGender.innerHTML = '女';
            } else {
                tdGender.innerHTML = '男';
            }
            $(tr).append(tdGender);

            var tdClass = document.createElement('td');
            var text = $('select[name="classes"]').find('option[value="' + postData.classes + '"]').text();
            tdClass.innerHTML = text;
            $(tr).append(tdClass);

            var tdHandle = document.createElement('td');
            tdHandle.innerHTML = '<a id="remove" class="remove"><span class="glyphicon glyphicon-remove"></span></a><a id="change" class="editRow"><span class="fa fa-pencil-square-o"></span></a>'
            $(tr).append(tdHandle);

            $('#tb').append(tr)


        }

    </script>
</body>

</html>